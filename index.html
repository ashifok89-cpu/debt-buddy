<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DebtBuddy">
<meta name="theme-color" content="#070A10">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>DebtBuddy</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#070A10;--bg2:#0D1117;--surface:#151B28;--card:#1A2233;--border:#1F2A3D;
  --border2:#283650;--accent:#4F8CFF;--accent2:#3B6FDB;--accentDim:rgba(79,140,255,.1);
  --red:#EF4565;--redDim:rgba(239,69,101,.08);--redBorder:rgba(239,69,101,.2);
  --green:#00C897;--greenDim:rgba(0,200,151,.08);--greenBorder:rgba(0,200,151,.2);
  --sar:#F7B84E;--sarDim:rgba(247,184,78,.08);--sarBorder:rgba(247,184,78,.2);
  --inr:#8B7DFA;--inrDim:rgba(139,125,250,.08);--inrBorder:rgba(139,125,250,.2);
  --text:#E6ECF5;--text2:#8493AB;--text3:#4A5568;
  --font:'Plus Jakarta Sans',-apple-system,BlinkMacSystemFont,sans-serif;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;overflow-x:hidden}
::-webkit-scrollbar{display:none}
select option{background:var(--surface);color:var(--text)}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.5)}
input:focus,select:focus{border-color:var(--accent)!important;outline:none;box-shadow:0 0 0 3px rgba(79,140,255,.12)}

/* â”€â”€ Layout â”€â”€ */
.header{padding:52px 22px 10px}
.header h1{font-size:20px;font-weight:800;letter-spacing:-.3px;display:flex;align-items:center;gap:8px;color:var(--text)}
.header h1 .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#4F8CFF,#3B6FDB);display:flex;align-items:center;justify-content:center;font-size:14px}
.content{padding:0 18px 100px}

/* â”€â”€ Components â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
.field{margin-bottom:14px}
.field label{display:block;font-size:10px;font-weight:700;color:var(--text2);margin-bottom:6px;letter-spacing:1.2px;text-transform:uppercase}
.field input,.field select{
  width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid var(--border);
  font-size:14px;color:var(--text);background:var(--surface);font-family:var(--font);transition:all .2s;
}
.btn{
  width:100%;padding:13px;border-radius:13px;border:none;font-size:14px;font-weight:700;
  cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s;
}
.btn:active{transform:scale(.98)}
.btn:disabled{background:var(--border)!important;color:var(--text3)!important;cursor:default;transform:none}
.toggle{display:flex;background:var(--surface);border-radius:14px;padding:3px;margin-bottom:20px;border:1px solid var(--border);gap:3px}
.toggle button{flex:1;padding:11px;border-radius:11px;border:none;cursor:pointer;font-size:13px;font-weight:700;font-family:var(--font);background:transparent;color:var(--text3);transition:all .2s}
.chips{display:flex;gap:6px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px}
.chip{
  padding:7px 13px;border-radius:20px;border:1.5px solid var(--border);background:transparent;
  color:var(--text2);font-size:11px;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;transition:all .15s;
}
.empty{text-align:center;padding:36px 20px;border-radius:16px;border:1.5px dashed var(--border);color:var(--text3)}
.badge{font-size:10px;font-weight:700;padding:3px 7px;border-radius:6px;display:inline-block}
.modal-bg{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);display:flex;align-items:flex-end;justify-content:center}
.modal{width:100%;max-width:480px;background:var(--bg2);border-radius:22px 22px 0 0;padding:8px 20px 32px;max-height:85vh;overflow-y:auto;animation:slideUp .25s ease-out;border-top:1px solid var(--border)}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}

/* â”€â”€ Tabbar â”€â”€ */
.tabbar{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;
  display:flex;justify-content:space-around;
  background:rgba(7,10,16,.94);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);
  border-top:1px solid var(--border);padding:6px 0 22px;z-index:100;
}
.tab-btn{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;cursor:pointer;padding:6px 6px 0;min-width:50px;font-family:var(--font)}
.tab-icon{font-size:18px;line-height:1}
.tab-label{font-size:9px;font-weight:700;letter-spacing:.3px}
.tab-dot{width:4px;height:4px;border-radius:2px;background:var(--accent);margin-top:-1px}

/* â”€â”€ Transaction row â”€â”€ */
.tx-row{
  display:grid;grid-template-columns:1fr 66px 44px 62px 66px;gap:3px;padding:10px 12px;
  border-radius:12px;background:var(--card);border:1px solid var(--border);margin-bottom:6px;
  align-items:center;cursor:pointer;transition:all .15s;
}
.tx-row:active{background:var(--surface)}
.tx-row.closed{opacity:.45;cursor:default}
.tx-header{display:grid;grid-template-columns:1fr 66px 44px 62px 66px;gap:3px;padding:6px 12px;font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border);margin-bottom:6px}
.person-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:8px;transition:all .15s}
.person-row:active{background:var(--surface)}
.avatar{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0}
.small-btn{padding:7px 11px;border-radius:8px;border:none;font-size:11px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .15s}
.small-btn:active{transform:scale(.95)}
.stat-row{display:flex;gap:8px}
.stat-card{flex:1;padding:13px 14px;border-radius:14px}
.divider{height:1px;background:var(--border);margin:8px 0 20px}
.download-btn{display:flex;align-items:center;gap:12px;width:100%;padding:14px;border-radius:14px;background:var(--card);border:1px solid var(--border);cursor:pointer;margin-bottom:8px;font-family:var(--font);text-align:left;transition:all .15s}
.download-btn:active{background:var(--surface)}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.success-toast{padding:12px;border-radius:12px;background:var(--greenDim);border:1px solid var(--greenBorder);text-align:center;color:var(--green);font-size:13px;font-weight:600;margin-top:12px}
</style>
</head>
<body>

<div id="loading" style="display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:12px">
  <div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#4F8CFF,#3B6FDB);display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ’°</div>
  <div id="loading-text" style="color:var(--text2);font-size:13px;font-weight:600">Loading...</div>
</div>
<div id="app" style="display:none"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” Set your Apps Script URL here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var API_URL = 'https://script.google.com/macros/s/AKfycbxVWf41nY2zF94qScz9BEpSyAszO00oaG7Hr9lQ_3HbUjD_I4XRNlJ1htnNfFPJHvI7/exec';  // â† Paste your /exec URL here

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var S = {people:[],transactions:[],tab:'balance',subTab:'borrow'};
var selectedCur='SAR',settleTarget=null,txFilter='all',txPerson='all';
var settlePerson='',settleAmount='',settleCurrency='SAR';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function api(action,data){
  return fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action:action,data:data||{}})
  }).then(function(r){return r.json()});
}
function apiGet(){
  return fetch(API_URL,{redirect:'follow'}).then(function(r){return r.json()});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n,c){return (c==='SAR'?'ï·¼':'â‚¹')+' '+Math.abs(n).toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2})}
function fmtD(d){if(!d||d==='')return'â€”';try{return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}catch(e){return String(d)}}
function today(){return new Date().toISOString().split('T')[0]}
function ini(n){var p=String(n).split(' '),r='';for(var i=0;i<p.length&&i<2;i++)if(p[i].length>0)r+=p[i][0];return r.toUpperCase()}
function rgba(hex,a){return'rgba('+parseInt(hex.slice(1,3),16)+','+parseInt(hex.slice(3,5),16)+','+parseInt(hex.slice(5,7),16)+','+a+')'}
function calc(cur){var owed=0,owe=0;for(var i=0;i<S.transactions.length;i++){var t=S.transactions[i],due=t.amount-(t.settled||0);if(due<=0||t.currency!==cur)continue;if(t.type==='lend')owed+=due;else owe+=due}return{owed:owed,owe:owe,net:owed-owe}}
function fp(id){for(var i=0;i<S.people.length;i++)if(S.people[i].id===id)return S.people[i];return null}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  var app=document.getElementById('app');
  var title=S.tab==='balance'?'Dashboard':S.tab==='add'?(S.subTab==='settle'?'Settle Dues':'Add Transaction'):S.tab==='transactions'?'Transactions':S.tab==='people'?'People':'Settings';
  if(S.tab==='transactions'&&txPerson!=='all'){var hp=fp(txPerson);if(hp)title=hp.name}
  var h='<div class="header"><h1><div class="logo">ğŸ’°</div>'+title+'</h1></div><div class="content">';
  if(S.tab==='balance')h+=renderBalance();
  else if(S.tab==='add')h+=renderAdd();
  else if(S.tab==='transactions')h+=renderTx();
  else if(S.tab==='people')h+=renderPeople();
  else h+=renderSettings();
  h+='</div>'+renderTabBar();
  app.innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BALANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBalance(){
  var h='';
  var curs=[{c:'SAR',color:'var(--sar)',dim:'var(--sarDim)',bdr:'var(--sarBorder)',sym:'ï·¼',label:'Saudi Riyal'},{c:'INR',color:'var(--inr)',dim:'var(--inrDim)',bdr:'var(--inrBorder)',sym:'â‚¹',label:'Indian Rupee'}];
  for(var ci=0;ci<curs.length;ci++){
    var c=curs[ci],s=calc(c.c);
    if(ci>0)h+='<div class="divider"></div>';
    var nc=s.net>=0?'var(--green)':'var(--red)',ns=s.net>=0?'+':'-';
    h+='<div style="margin-bottom:16px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">';
    h+='<div style="width:36px;height:36px;border-radius:10px;background:'+c.dim+';border:1px solid '+c.bdr+';display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:'+c.color+'">'+c.sym+'</div>';
    h+='<div><div style="font-size:13px;font-weight:700">'+c.c+'</div><div style="font-size:10px;color:var(--text3)">'+c.label+'</div></div>';
    h+='<div style="margin-left:auto;text-align:right"><div style="font-size:10px;color:var(--text3)">Net Balance</div>';
    h+='<div style="font-size:17px;font-weight:800;color:'+nc+'">'+ns+fmt(s.net,c.c)+'</div></div></div>';
    h+='<div class="stat-row">';
    h+='<div class="stat-card" style="background:var(--greenDim);border:1px solid var(--greenBorder)"><div style="font-size:10px;font-weight:700;color:var(--green);margin-bottom:4px">â†‘ Owed to You</div><div style="font-size:17px;font-weight:800;color:var(--green)">'+fmt(s.owed,c.c)+'</div></div>';
    h+='<div class="stat-card" style="background:var(--redDim);border:1px solid var(--redBorder)"><div style="font-size:10px;font-weight:700;color:var(--red);margin-bottom:4px">â†“ You Owe</div><div style="font-size:17px;font-weight:800;color:var(--red)">'+fmt(s.owe,c.c)+'</div></div>';
    h+='</div></div>';
  }
  // Recent
  h+='<div style="margin-top:6px"><div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:10px;letter-spacing:1px">RECENT ACTIVITY</div>';
  if(!S.transactions.length){h+='<div class="empty"><div style="font-size:28px;margin-bottom:6px">ğŸ“Š</div><div style="font-size:13px;font-weight:600">No transactions yet</div></div>'}
  else{var r=S.transactions.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)}).slice(0,5);
    for(var i=0;i<r.length;i++){var tx=r[i],p=fp(tx.personId),il=tx.type==='lend',ac=il?'var(--green)':'var(--red)';
      h+='<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:var(--card);margin-bottom:6px;border:1px solid var(--border)">';
      h+='<div style="width:32px;height:32px;border-radius:9px;background:'+(il?'var(--greenDim)':'var(--redDim)')+';display:flex;align-items:center;justify-content:center;font-size:13px;color:'+ac+';font-weight:700">'+(il?'â†‘':'â†“')+'</div>';
      h+='<div style="flex:1"><div style="font-size:12px;font-weight:600">'+(p?p.name:'?')+'</div><div style="font-size:10px;color:var(--text3)">'+(tx.note||(il?'Lent':'Borrowed'))+' Â· '+fmtD(tx.date)+'</div></div>';
      h+='<div style="font-size:13px;font-weight:700;color:'+ac+'">'+(il?'+':'-')+fmt(tx.amount,tx.currency)+'</div></div>';
    }}
  h+='</div>';return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdd(){
  var iB=S.subTab==='borrow',iL=S.subTab==='lend',iS=S.subTab==='settle';
  var h='<div class="toggle">';
  h+='<button style="'+(iB?'background:var(--red);color:#fff':'')+ '" onclick="S.subTab=\'borrow\';render()">Borrow</button>';
  h+='<button style="'+(iL?'background:var(--green);color:#fff':'')+'" onclick="S.subTab=\'lend\';render()">Lend</button>';
  h+='<button style="'+(iS?'background:var(--accent);color:#fff':'')+'" onclick="S.subTab=\'settle\';render()">Settle</button>';
  h+='</div>';
  if(iS) return h+renderSettle();
  // Hint
  h+='<div class="card" style="background:'+(iB?'var(--redDim)':'var(--greenDim)')+';border-color:'+(iB?'var(--redBorder)':'var(--greenBorder)')+';padding:10px 14px;font-size:12px;font-weight:500;color:'+(iB?'var(--red)':'var(--green)')+'">'+
    (iB?'ğŸ’¸ Recording money you borrowed (you will owe)':'ğŸ¤ Recording money you lent (they will owe you)')+'</div>';
  // Form
  h+='<div class="field"><label>Person</label><select id="f-person"><option value="">Select person...</option>';
  for(var i=0;i<S.people.length;i++) h+='<option value="'+S.people[i].id+'">'+S.people[i].name+'</option>';
  h+='</select></div>';
  h+='<div class="field"><label>Date</label><input type="date" id="f-date" value="'+today()+'"></div>';
  var ss=selectedCur==='SAR';
  h+='<div class="field"><label>Currency</label><div style="display:flex;gap:8px">';
  h+='<button onclick="pickCur(\'SAR\')" style="flex:1;padding:11px;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font);border:1.5px solid '+(ss?'var(--sar)':'var(--border)')+';background:'+(ss?'var(--sarDim)':'var(--surface)')+';color:'+(ss?'var(--sar)':'var(--text3)')+'">ï·¼ SAR</button>';
  h+='<button onclick="pickCur(\'INR\')" style="flex:1;padding:11px;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font);border:1.5px solid '+(!ss?'var(--inr)':'var(--border)')+';background:'+(!ss?'var(--inrDim)':'var(--surface)')+';color:'+(!ss?'var(--inr)':'var(--text3)')+'">â‚¹ INR</button>';
  h+='</div></div>';
  h+='<div class="field"><label>Amount</label><input type="number" id="f-amount" placeholder="0.00" style="font-size:20px;font-weight:700;text-align:center"></div>';
  h+='<div class="field"><label>Note (optional)</label><input type="text" id="f-note" placeholder="e.g. Lunch, Rent, Tickets..."></div>';
  h+='<button class="btn" style="background:'+(iB?'var(--red)':'var(--green)')+';color:#fff" onclick="submitTx()">'+(iB?'â†“ Add Borrow':'â†‘ Add Lend')+'</button>';
  h+='<div id="add-msg"></div>';
  if(!S.people.length) h+='<div style="margin-top:14px;padding:10px 14px;border-radius:12px;background:var(--sarDim);border:1px solid var(--sarBorder);text-align:center;color:var(--sar);font-size:12px;font-weight:500">Add people first in the People tab</div>';
  return h;
}
function pickCur(c){selectedCur=c;render()}
function submitTx(){
  var pid=document.getElementById('f-person').value,date=document.getElementById('f-date').value,
    amt=parseFloat(document.getElementById('f-amount').value),note=document.getElementById('f-note').value;
  if(!pid||!date||!amt||amt<=0){alert('Please fill all required fields');return}
  api('addTransaction',{personId:pid,type:S.subTab==='borrow'?'owe':'lend',currency:selectedCur,amount:amt,note:note,date:date})
    .then(function(tx){
      S.transactions.push(tx);
      document.getElementById('f-person').value='';document.getElementById('f-amount').value='';document.getElementById('f-note').value='';
      var m=document.getElementById('add-msg');if(m)m.innerHTML='<div class="success-toast">âœ“ Transaction added!</div>';
      setTimeout(function(){var m2=document.getElementById('add-msg');if(m2)m2.innerHTML=''},2500);
    }).catch(function(e){alert('Error: '+e.message)});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTLE (FIFO)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettle(){
  var h='<div class="card" style="background:var(--accentDim);border-color:rgba(79,140,255,.2);padding:10px 14px;font-size:12px;color:var(--accent)">Enter amount â€” auto-allocated oldest dues first</div>';
  h+='<div class="field"><label>Person</label><select id="settle-person" onchange="settlePerson=this.value;settleAmount=\'\';render()">';
  h+='<option value="">Select person...</option>';
  for(var i=0;i<S.people.length;i++) h+='<option value="'+S.people[i].id+'"'+(settlePerson===S.people[i].id?' selected':'')+'>'+S.people[i].name+'</option>';
  h+='</select></div>';
  if(!settlePerson) return h;

  var dueTxs=[],tSAR=0,tINR=0;
  for(var j=0;j<S.transactions.length;j++){var t=S.transactions[j];if(t.personId!==settlePerson)continue;var d=t.amount-(t.settled||0);if(d<=0)continue;dueTxs.push(t);if(t.currency==='SAR')tSAR+=d;else tINR+=d}
  dueTxs.sort(function(a,b){return new Date(a.date)-new Date(b.date)});

  if(!dueTxs.length){h+='<div class="empty" style="padding:28px"><div style="font-size:24px;margin-bottom:6px">ğŸ‰</div><div style="font-size:13px;font-weight:700">All settled!</div></div>';return h}

  // Total outstanding
  h+='<div class="card" style="padding:14px"><div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:8px;letter-spacing:.5px">TOTAL OUTSTANDING</div>';
  if(tSAR>0) h+='<div style="font-size:16px;font-weight:700;color:var(--sar)">'+fmt(tSAR,'SAR')+'</div>';
  if(tINR>0) h+='<div style="font-size:16px;font-weight:700;color:var(--inr)'+(tSAR?';margin-top:4px':'')+'">'+fmt(tINR,'INR')+'</div>';
  h+='</div>';

  if(tSAR>0&&tINR>0){var sc=settleCurrency==='SAR';
    h+='<div class="field"><label>Settle Currency</label><div style="display:flex;gap:8px">';
    h+='<button onclick="settleCurrency=\'SAR\';settleAmount=\'\';render()" style="flex:1;padding:11px;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font);border:1.5px solid '+(sc?'var(--sar)':'var(--border)')+';background:'+(sc?'var(--sarDim)':'var(--surface)')+';color:'+(sc?'var(--sar)':'var(--text3)')+'">ï·¼ SAR</button>';
    h+='<button onclick="settleCurrency=\'INR\';settleAmount=\'\';render()" style="flex:1;padding:11px;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font);border:1.5px solid '+(!sc?'var(--inr)':'var(--border)')+';background:'+(!sc?'var(--inrDim)':'var(--surface)')+';color:'+(!sc?'var(--inr)':'var(--text3)')+'">â‚¹ INR</button>';
    h+='</div></div>';
  } else settleCurrency=tSAR>0?'SAR':'INR';

  var curDues=[],curTotal=0;
  for(var cd=0;cd<dueTxs.length;cd++) if(dueTxs[cd].currency===settleCurrency){var dd=dueTxs[cd].amount-(dueTxs[cd].settled||0);curDues.push(dueTxs[cd]);curTotal+=dd}
  if(!curDues.length){h+='<div class="empty" style="padding:20px"><div style="font-size:12px;font-weight:600">No '+settleCurrency+' dues</div></div>';return h}

  h+='<div class="field"><label>Settlement Date</label><input type="date" id="settle-date" value="'+today()+'"></div>';
  h+='<div class="field"><label>Amount ('+settleCurrency+')</label><input type="number" id="settle-amt" placeholder="0.00" value="'+(settleAmount||'')+'" oninput="settleAmount=this.value;renderPreview()" style="font-size:20px;font-weight:700;text-align:center"></div>';

  // Quick buttons
  h+='<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">';
  h+='<button onclick="setAmt('+curTotal.toFixed(2)+')" class="small-btn" style="background:var(--accentDim);color:var(--accent)">Full: '+fmt(curTotal,settleCurrency)+'</button>';
  if(curDues.length>1){var f1=curDues[0].amount-(curDues[0].settled||0);h+='<button onclick="setAmt('+f1.toFixed(2)+')" class="small-btn" style="background:var(--greenDim);color:var(--green)">Oldest: '+fmt(f1,settleCurrency)+'</button>'}
  h+='<button onclick="setAmt(\'\')" class="small-btn" style="background:var(--redDim);color:var(--red)">Clear</button></div>';

  h+='<div id="settle-preview">'+buildPreview(curDues,parseFloat(settleAmount)||0,settleCurrency)+'</div>';
  h+='<div id="settle-msg"></div>';
  return h;
}

function buildPreview(dues,amt,cur){
  var h='',rem=amt,allocs=[];
  h+='<div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:8px;letter-spacing:.5px">'+dues.length+' DUES Â· OLDEST FIRST</div>';
  for(var n=0;n<dues.length;n++){
    var tx=dues[n],due=tx.amount-(tx.settled||0),il=tx.type==='lend',ac=il?'var(--green)':'var(--red)';
    var alloc=0;if(rem>0){alloc=Math.min(rem,due);rem-=alloc}
    var full=alloc>=due&&alloc>0,part=alloc>0&&alloc<due,none=alloc===0;
    var bdr=full?'var(--greenBorder)':(part?'rgba(79,140,255,.35)':'var(--border)');
    var bg=full?'var(--greenDim)':(part?'var(--accentDim)':'var(--card)');

    h+='<div style="display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:12px;background:'+bg+';border:1.5px solid '+bdr+';margin-bottom:6px">';
    if(full) h+='<div style="width:22px;height:22px;border-radius:6px;background:var(--green);display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="color:#fff;font-size:11px;font-weight:700">âœ“</span></div>';
    else if(part) h+='<div style="width:22px;height:22px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="color:#fff;font-size:9px;font-weight:800">Â½</span></div>';
    else h+='<div style="width:22px;height:22px;border-radius:6px;border:2px solid var(--text3);flex-shrink:0"></div>';

    h+='<div style="flex:1"><div style="font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px"><span style="color:'+ac+';font-size:10px">'+(il?'â†‘':'â†“')+'</span>'+(tx.note||(il?'Lent':'Borrowed'))+'</div>';
    h+='<div style="font-size:10px;color:var(--text3)">'+fmtD(tx.date)+'</div></div>';
    h+='<div style="text-align:right"><div style="font-size:13px;font-weight:700;color:'+(none?'var(--text3)':(full?'var(--green)':'var(--accent)'))+'">'+fmt(due,cur)+'</div>';
    if(part) h+='<div style="font-size:9px;font-weight:600;color:var(--accent);margin-top:1px">pays '+fmt(alloc,cur)+'</div>';
    else if(full) h+='<div style="font-size:9px;font-weight:600;color:var(--green);margin-top:1px">fully paid</div>';
    h+='</div></div>';
    if(alloc>0) allocs.push({id:tx.id,amount:alloc});
  }
  window._allocs=allocs;
  if(rem>0&&amt>0) h+='<div style="padding:8px 12px;border-radius:10px;background:var(--sarDim);border:1px solid var(--sarBorder);color:var(--sar);font-size:11px;font-weight:600;margin-bottom:8px">âš  Excess: '+fmt(rem,cur)+'</div>';
  if(allocs.length>0&&amt>0){
    var st=0;for(var a=0;a<allocs.length;a++)st+=allocs[a].amount;
    h+='<div class="card" style="background:var(--accentDim);border-color:rgba(79,140,255,.2);margin-top:12px;margin-bottom:12px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:var(--text2)">'+allocs.length+' transaction'+(allocs.length>1?'s':'')+'</span>';
    h+='<span style="font-size:17px;font-weight:800;color:var(--accent)">'+fmt(st,cur)+'</span></div></div>';
    h+='<button class="btn" style="background:var(--accent);color:#fff" onclick="submitSettle()">âœ“ Settle '+allocs.length+' Transaction'+(allocs.length>1?'s':'')+'</button>';
  }
  return h;
}
function setAmt(v){settleAmount=v===''?'':String(v);render()}
function renderPreview(){
  var el=document.getElementById('settle-preview');if(!el)return;
  var inp=document.getElementById('settle-amt');settleAmount=inp?inp.value:'';
  var a=parseFloat(settleAmount)||0,cd=[];
  for(var j=0;j<S.transactions.length;j++){var t=S.transactions[j];if(t.personId!==settlePerson||t.currency!==settleCurrency)continue;var d=t.amount-(t.settled||0);if(d<=0)continue;cd.push(t)}
  cd.sort(function(a,b){return new Date(a.date)-new Date(b.date)});
  el.innerHTML=buildPreview(cd,a,settleCurrency);
}
function submitSettle(){
  var al=window._allocs;if(!al||!al.length)return;
  var de=document.getElementById('settle-date'),dt=de?de.value:today();
  api('settleMultiple',{allocations:al,date:dt}).then(function(results){
    for(var r=0;r<results.length;r++)for(var i=0;i<S.transactions.length;i++)if(S.transactions[i].id===results[r].id){S.transactions[i].settled=results[r].settled;S.transactions[i].settledDate=results[r].settledDate;break}
    settleAmount='';render();
    setTimeout(function(){var m=document.getElementById('settle-msg');if(m)m.innerHTML='<div class="success-toast">âœ“ '+results.length+' transaction'+(results.length>1?'s':'')+' settled!</div>';setTimeout(function(){var m2=document.getElementById('settle-msg');if(m2)m2.innerHTML=''},3000)},50);
  }).catch(function(e){alert('Error: '+e.message)});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTx(){
  var txs=[];
  for(var i=0;i<S.transactions.length;i++){var t=S.transactions[i];if(txPerson!=='all'&&t.personId!==txPerson)continue;var d=t.amount-(t.settled||0);if(txFilter==='due'&&d<=0)continue;if(txFilter==='closed'&&d>0)continue;txs.push(t)}
  txs.sort(function(a,b){return new Date(b.date)-new Date(a.date)});

  var h='<div class="chips">';
  h+='<button class="chip" style="'+(txFilter==='all'?'border-color:var(--accent);background:var(--accentDim);color:var(--accent)':'')+'" onclick="txFilter=\'all\';render()">All</button>';
  h+='<button class="chip" style="'+(txFilter==='due'?'border-color:var(--red);background:var(--redDim);color:var(--red)':'')+'" onclick="txFilter=\'due\';render()">On Due</button>';
  h+='<button class="chip" style="'+(txFilter==='closed'?'border-color:var(--green);background:var(--greenDim);color:var(--green)':'')+'" onclick="txFilter=\'closed\';render()">Closed</button>';
  h+='</div>';
  h+='<div class="field" style="margin-bottom:14px"><select onchange="txPerson=this.value;render()">';
  h+='<option value="all"'+(txPerson==='all'?' selected':'')+'>All People</option>';
  for(var pi=0;pi<S.people.length;pi++) h+='<option value="'+S.people[pi].id+'"'+(txPerson===S.people[pi].id?' selected':'')+'>'+S.people[pi].name+'</option>';
  h+='</select></div>';

  // Summary card
  if(txPerson!=='all'){
    var sp=fp(txPerson),sm={SAR:{l:0,b:0,dl:0,db:0},INR:{l:0,b:0,dl:0,db:0}};
    for(var si=0;si<S.transactions.length;si++){var st=S.transactions[si];if(st.personId!==txPerson)continue;var sd2=st.amount-(st.settled||0),bk=sm[st.currency];
      if(st.type==='lend'){bk.l+=st.amount;if(sd2>0)bk.dl+=sd2}else{bk.b+=st.amount;if(sd2>0)bk.db+=sd2}}
    h+='<div class="card" style="margin-bottom:14px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">';
    h+='<div class="avatar" style="background:var(--accentDim);color:var(--accent)">'+ini(sp?sp.name:'?')+'</div>';
    h+='<div><div style="font-size:15px;font-weight:700">'+(sp?sp.name:'?')+'</div><div style="font-size:10px;color:var(--text3)">Balance Summary</div></div></div>';
    var sums=[{c:'SAR',sym:'ï·¼',col:'var(--sar)',d:sm.SAR},{c:'INR',sym:'â‚¹',col:'var(--inr)',d:sm.INR}];
    for(var ssi=0;ssi<sums.length;ssi++){var sc=sums[ssi],sd=sc.d;if(!sd.l&&!sd.b)continue;var sn=sd.dl-sd.db,snc=sn>=0?'var(--green)':'var(--red)',snl=sn>0?'owes you':(sn<0?'you owe':'settled');
      if(ssi>0&&(sums[0].d.l+sums[0].d.b>0)) h+='<div style="height:1px;background:var(--border);margin:10px 0"></div>';
      h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;font-weight:700;color:'+sc.col+'">'+sc.sym+' '+sc.c+'</span>';
      h+='<div style="text-align:right"><div style="font-size:10px;color:var(--text3)">'+snl+'</div><div style="font-size:18px;font-weight:800;color:'+snc+'">'+(sn>=0?'+':'-')+fmt(sn,sc.c)+'</div></div></div>';
      h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
      h+='<div style="padding:8px 10px;border-radius:10px;background:var(--greenDim);border:1px solid var(--greenBorder)"><div style="font-size:9px;font-weight:700;color:var(--green);margin-bottom:3px">â†‘ THEY OWE</div><div style="font-size:14px;font-weight:700;color:var(--green)">'+fmt(sd.dl,sc.c)+'</div></div>';
      h+='<div style="padding:8px 10px;border-radius:10px;background:var(--redDim);border:1px solid var(--redBorder)"><div style="font-size:9px;font-weight:700;color:var(--red);margin-bottom:3px">â†“ YOU OWE</div><div style="font-size:14px;font-weight:700;color:var(--red)">'+fmt(sd.db,sc.c)+'</div></div></div>';
    }
    h+='<div style="text-align:center;margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-size:9px;color:var(--text3)">As of '+fmtD(today())+' Â· DebtBuddy</div></div>';
    // Download buttons
    h+='<div style="display:flex;gap:6px;margin-bottom:14px">';
    h+='<button onclick="downloadImage()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:10px;border-radius:11px;background:var(--accentDim);border:1px solid rgba(79,140,255,.2);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font)">ğŸ“¸ Image</button>';
    h+='<button onclick="downloadPrint()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:10px;border-radius:11px;background:var(--sarDim);border:1px solid var(--sarBorder);color:var(--sar);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font)">ğŸ–¨ PDF</button>';
    h+='</div>';
  }

  // Table
  h+='<div class="tx-header"><div>Person</div><div>Date</div><div>Cur</div><div style="text-align:right">Amt</div><div style="text-align:right">Due</div></div>';
  if(!txs.length) h+='<div class="empty"><div style="font-size:24px;margin-bottom:6px">ğŸ“‹</div><div style="font-size:12px;font-weight:600">No transactions found</div></div>';
  else for(var ti=0;ti<txs.length;ti++){
    var tx=txs[ti],p=fp(tx.personId),due=tx.amount-(tx.settled||0),cl=due<=0,il=tx.type==='lend';
    var ac=il?'var(--green)':'var(--red)',dc=cl?'var(--green)':(il?'var(--green)':'var(--red)');
    var cc=tx.currency==='SAR'?'var(--sar)':'var(--inr)',cb=tx.currency==='SAR'?'var(--sarDim)':'var(--inrDim)';
    h+='<div class="tx-row'+(cl?' closed':'')+'"'+(cl?'':' onclick="openSettle(\''+tx.id+'\')"')+'>';
    h+='<div><div style="font-size:12px;font-weight:600;display:flex;align-items:center;gap:3px"><span style="color:'+ac+';font-size:10px">'+(il?'â†‘':'â†“')+'</span>'+(p?p.name:'?')+'</div>';
    if(tx.note) h+='<div style="font-size:9px;color:var(--text3);margin-top:1px">'+tx.note+'</div>';
    if(tx.settled>0&&tx.settledDate) h+='<div style="font-size:9px;color:var(--green);margin-top:1px">Settled '+fmt(tx.settled,tx.currency)+' Â· '+fmtD(tx.settledDate)+'</div>';
    h+='</div><div style="font-size:10px;color:var(--text3)">'+fmtD(tx.date)+'</div>';
    h+='<div class="badge" style="color:'+cc+';background:'+cb+'">'+tx.currency+'</div>';
    h+='<div style="font-size:12px;font-weight:700;text-align:right">'+fmt(tx.amount,tx.currency)+'</div>';
    h+='<div style="font-size:12px;font-weight:700;text-align:right;color:'+dc+'">'+(cl?'âœ“':fmt(due,tx.currency))+'</div></div>';
  }
  h+='<div id="settle-modal"></div>';return h;
}
function openSettle(id){
  settleTarget=null;for(var i=0;i<S.transactions.length;i++)if(S.transactions[i].id===id){settleTarget=S.transactions[i];break}
  if(!settleTarget)return;var due=settleTarget.amount-(settleTarget.settled||0),p=fp(settleTarget.personId);
  var m=document.getElementById('settle-modal');
  var h='<div class="modal-bg" onclick="if(event.target===this)closeSettle()"><div class="modal"><div style="width:36px;height:4px;border-radius:2px;background:var(--border);margin:8px auto 16px"></div>';
  h+='<h3 style="font-size:17px;font-weight:700;margin-bottom:16px">Settle Transaction</h3>';
  h+='<div class="card"><div style="font-size:11px;color:var(--text2)">'+(p?p.name:'?')+' Â· '+(settleTarget.type==='lend'?'Lent':'Borrowed')+' Â· '+settleTarget.currency+'</div>';
  h+='<div style="font-size:17px;font-weight:700;margin-top:4px">'+fmt(settleTarget.amount,settleTarget.currency)+'</div>';
  h+='<div style="font-size:12px;color:var(--red);margin-top:2px">Due: '+fmt(due,settleTarget.currency)+'</div></div>';
  h+='<div class="field"><label>Amount</label><input type="number" id="s-amount" value="'+due.toFixed(2)+'" style="font-size:18px;font-weight:700;text-align:center"></div>';
  h+='<div class="field"><label>Date</label><input type="date" id="s-date" value="'+today()+'"></div>';
  h+='<button class="btn" style="background:var(--green);color:#fff" onclick="doSettle()">âœ“ Settle</button>';
  h+='</div></div>';m.innerHTML=h;
}
function closeSettle(){var m=document.getElementById('settle-modal');if(m)m.innerHTML=''}
function doSettle(){
  if(!settleTarget)return;var amt=parseFloat(document.getElementById('s-amount').value),date=document.getElementById('s-date').value;if(!amt||amt<=0)return;
  api('settleTransaction',{id:settleTarget.id,amount:amt,date:date}).then(function(r){
    for(var i=0;i<S.transactions.length;i++)if(S.transactions[i].id===settleTarget.id){S.transactions[i].settled=r.settled;S.transactions[i].settledDate=r.settledDate;break}
    settleTarget=null;render();
  }).catch(function(e){alert('Error: '+e.message)});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadImage(){
  var content=document.getElementById('app');var tb=content.querySelector('.tabbar');if(tb)tb.style.display='none';
  if(typeof html2canvas==='undefined'){alert('Image library loading, try again.');if(tb)tb.style.display='';return}
  html2canvas(content,{backgroundColor:'#070A10',scale:2,useCORS:true,logging:false}).then(function(canvas){
    if(tb)tb.style.display='';var a=document.createElement('a');var pn=txPerson!=='all'?(fp(txPerson)||{}).name||'unknown':'all';
    a.download='debtbuddy-'+pn.replace(/\s+/g,'-').toLowerCase()+'-'+today()+'.png';a.href=canvas.toDataURL('image/png');document.body.appendChild(a);a.click();document.body.removeChild(a);
  }).catch(function(){if(tb)tb.style.display='';alert('Could not generate image')});
}
function downloadPrint(){
  var sp=fp(txPerson),pn=sp?sp.name:'All';
  var txs=[];for(var i=0;i<S.transactions.length;i++){var t=S.transactions[i];if(txPerson!=='all'&&t.personId!==txPerson)continue;var d=t.amount-(t.settled||0);if(txFilter==='due'&&d<=0)continue;if(txFilter==='closed'&&d>0)continue;txs.push(t)}
  txs.sort(function(a,b){return new Date(b.date)-new Date(a.date)});
  var sm={SAR:{dl:0,db:0},INR:{dl:0,db:0}};if(txPerson!=='all')for(var j=0;j<S.transactions.length;j++){var st=S.transactions[j];if(st.personId!==txPerson)continue;var sd=st.amount-(st.settled||0);if(sd<=0)continue;if(st.type==='lend')sm[st.currency].dl+=sd;else sm[st.currency].db+=sd}
  var html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>DebtBuddy - '+pn+'</title><style>body{font-family:Arial,sans-serif;max-width:700px;margin:20px auto;padding:20px;color:#222}h1{font-size:20px;margin:0 0 4px}.sub{color:#666;font-size:12px;margin-bottom:18px}.summary{display:flex;gap:12px;margin-bottom:16px}.sc{flex:1;padding:12px;border-radius:8px;border:1px solid #ddd}.sc.g{border-color:#00C897;background:#f0fdf8}.sc.r{border-color:#EF4565;background:#fef2f4}.sl{font-size:10px;font-weight:600;margin-bottom:3px}.sv{font-size:16px;font-weight:700}table{width:100%;border-collapse:collapse;font-size:12px}th{text-align:left;padding:7px 8px;background:#f5f5f5;border-bottom:2px solid #ddd;font-size:10px;text-transform:uppercase;color:#666}td{padding:7px 8px;border-bottom:1px solid #eee}tr.c{opacity:.5}.g{color:#00896a}.r{color:#c0354a}.foot{text-align:center;margin-top:20px;color:#999;font-size:10px;border-top:1px solid #eee;padding-top:10px}@media print{body{margin:0;padding:10px}}</style></head><body>';
  html+='<h1>ğŸ’° DebtBuddy</h1><div class="sub">Transactions with '+pn+' Â· '+fmtD(today())+'</div>';
  if(txPerson!=='all'){var nS=sm.SAR.dl-sm.SAR.db,nI=sm.INR.dl-sm.INR.db;
    html+='<div class="summary"><div class="sc g"><div class="sl g">â†‘ They Owe You</div>';if(sm.SAR.dl>0)html+='<div class="sv g">'+fmt(sm.SAR.dl,'SAR')+'</div>';if(sm.INR.dl>0)html+='<div class="sv g">'+fmt(sm.INR.dl,'INR')+'</div>';if(!sm.SAR.dl&&!sm.INR.dl)html+='<div class="sv" style="color:#999">â€”</div>';
    html+='</div><div class="sc r"><div class="sl r">â†“ You Owe Them</div>';if(sm.SAR.db>0)html+='<div class="sv r">'+fmt(sm.SAR.db,'SAR')+'</div>';if(sm.INR.db>0)html+='<div class="sv r">'+fmt(sm.INR.db,'INR')+'</div>';if(!sm.SAR.db&&!sm.INR.db)html+='<div class="sv" style="color:#999">â€”</div>';html+='</div></div>'}
  html+='<table><thead><tr><th>Type</th><th>Person</th><th>Date</th><th>Cur</th><th>Amount</th><th>Note</th><th>Settled</th><th>Due</th></tr></thead><tbody>';
  for(var ti=0;ti<txs.length;ti++){var tx=txs[ti],p=fp(tx.personId),due=tx.amount-(tx.settled||0),cl=due<=0,il=tx.type==='lend';
    html+='<tr class="'+(cl?'c':'')+'"><td class="'+(il?'g':'r')+'">'+(il?'â†‘ Lent':'â†“ Borrowed')+'</td><td>'+(p?p.name:'?')+'</td><td>'+fmtD(tx.date)+'</td><td>'+tx.currency+'</td><td>'+fmt(tx.amount,tx.currency)+'</td><td>'+(tx.note||'â€”')+'</td><td>'+(tx.settled>0?fmt(tx.settled,tx.currency)+(tx.settledDate?' ('+fmtD(tx.settledDate)+')':''):'â€”')+'</td><td class="'+(cl?'g':(il?'g':'r'))+'">'+(cl?'âœ“ Paid':fmt(due,tx.currency))+'</td></tr>'}
  html+='</tbody></table><div class="foot">DebtBuddy Â· '+new Date().toLocaleString('en-GB')+'</div></body></html>';
  var w=window.open('','_blank');if(w){w.document.write(html);w.document.close();setTimeout(function(){w.print()},500)}else alert('Allow popups for Print/PDF');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEOPLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPeople(){
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">';
  h+='<div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:1px">'+S.people.length+' PEOPLE</div>';
  h+='<button onclick="addPersonPrompt()" style="padding:8px 14px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:12px;font-weight:700;font-family:var(--font)">+ Add</button></div>';
  if(!S.people.length) h+='<div class="empty"><div style="font-size:32px;margin-bottom:6px">ğŸ‘¥</div><div style="font-size:13px;font-weight:600">No people added yet</div></div>';
  else for(var i=0;i<S.people.length;i++){var p=S.people[i],tc=0;for(var j=0;j<S.transactions.length;j++)if(S.transactions[j].personId===p.id)tc++;
    var sn=p.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    h+='<div class="person-row"><div class="avatar" style="background:var(--accentDim);color:var(--accent)">'+ini(p.name)+'</div>';
    h+='<div style="flex:1"><div style="font-size:14px;font-weight:600">'+p.name+'</div><div style="font-size:10px;color:var(--text3)">'+tc+' txn'+(tc!==1?'s':'')+'</div></div>';
    h+='<div style="display:flex;gap:5px"><button class="small-btn" style="background:var(--accentDim);color:var(--accent)" onclick="editPersonPrompt(\''+p.id+'\',\''+sn+'\')">Edit</button>';
    h+='<button class="small-btn" style="background:var(--redDim);color:var(--red)" onclick="delPerson(\''+p.id+'\',\''+sn+'\')">Del</button></div></div>'}
  return h;
}
function addPersonPrompt(){var n=prompt("Person's name:");if(!n||!n.trim())return;api('addPerson',{name:n.trim()}).then(function(p){S.people.push(p);render()}).catch(function(e){alert('Error: '+e.message)})}
function editPersonPrompt(id,old){var n=prompt('Edit name:',old);if(!n||!n.trim())return;api('editPerson',{id:id,name:n.trim()}).then(function(p){for(var i=0;i<S.people.length;i++)if(S.people[i].id===id){S.people[i].name=p.name;break}render()}).catch(function(e){alert('Error: '+e.message)})}
function delPerson(id,name){if(!confirm('Delete '+name+'?'))return;api('deletePerson',{id:id}).then(function(){S.people=S.people.filter(function(p){return p.id!==id});S.transactions=S.transactions.filter(function(t){return t.personId!==id});render()}).catch(function(e){alert('Error: '+e.message)})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  var ac=0,se=0;for(var i=0;i<S.transactions.length;i++){if(S.transactions[i].amount-(S.transactions[i].settled||0)>0)ac++;else se++}
  var h='<div class="card"><div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:12px;letter-spacing:1px">DATA SUMMARY</div><div class="stats-grid">';
  var st=[{l:'People',v:S.people.length,c:'var(--accent)'},{l:'Transactions',v:S.transactions.length,c:'var(--sar)'},{l:'Active',v:ac,c:'var(--red)'},{l:'Settled',v:se,c:'var(--green)'}];
  for(var si=0;si<st.length;si++){var s=st[si];h+='<div style="padding:10px 12px;border-radius:11px;background:var(--surface);border:1px solid var(--border)"><div style="font-size:20px;font-weight:800;color:'+s.c+'">'+s.v+'</div><div style="font-size:10px;color:var(--text3);font-weight:600">'+s.l+'</div></div>'}
  h+='</div></div>';
  h+='<div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:10px;letter-spacing:1px">EXPORT DATA</div>';
  h+='<button class="download-btn" onclick="downloadCSV()"><div style="width:38px;height:38px;border-radius:10px;background:var(--greenDim);display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ“¥</div><div><div style="font-size:13px;font-weight:600">Download CSV</div><div style="font-size:10px;color:var(--text3)">Excel-compatible</div></div></button>';
  h+='<button class="download-btn" onclick="downloadJSON()"><div style="width:38px;height:38px;border-radius:10px;background:var(--accentDim);display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ’¾</div><div><div style="font-size:13px;font-weight:600">Download JSON</div><div style="font-size:10px;color:var(--text3)">Full backup</div></div></button>';
  h+='<div style="font-size:10px;font-weight:700;color:var(--red);margin:18px 0 10px;letter-spacing:1px">DANGER ZONE</div>';
  h+='<button class="btn" style="background:var(--redDim);border:1px solid var(--redBorder);color:var(--red)" onclick="if(confirm(\'Delete ALL data?\')){api(\'clearAll\').then(function(){S.people=[];S.transactions=[];render()})}">Clear All Data</button>';
  h+='<div style="text-align:center;margin-top:28px;color:var(--text3);font-size:10px">DebtBuddy v3.0</div>';
  return h;
}
function downloadCSV(){var l=['"Type","Person","Date","Currency","Amount","Note","Settled","Settled Date","Due"'];for(var i=0;i<S.transactions.length;i++){var t=S.transactions[i],p=fp(t.personId),d=t.amount-(t.settled||0);l.push('"'+(t.type==='lend'?'Lend':'Borrow')+'","'+(p?p.name:'?')+'","'+t.date+'","'+t.currency+'","'+t.amount+'","'+(t.note||'')+'","'+(t.settled||0)+'","'+(t.settledDate||'')+'","'+(d<=0?0:d)+'"')}var b=new Blob([l.join('\n')],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='debtbuddy-'+today()+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a)}
function downloadJSON(){var tx=[];for(var i=0;i<S.transactions.length;i++){var t=S.transactions[i],p=fp(t.personId),o={};for(var k in t)o[k]=t[k];o.personName=p?p.name:'?';tx.push(o)}var b=new Blob([JSON.stringify({exportedAt:new Date().toISOString(),people:S.people,transactions:tx},null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='debtbuddy-'+today()+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTabBar(){
  var tabs=[['balance','Home','ğŸ '],['add','Add','ï¼‹'],['transactions','Txns','ğŸ“‹'],['people','People','ğŸ‘¥'],['settings','Settings','âš™ï¸']];
  var h='<div class="tabbar">';
  for(var i=0;i<tabs.length;i++){var t=tabs[i],a=S.tab===t[0],c=a?'var(--accent)':'var(--text3)';
    h+='<button class="tab-btn" onclick="switchTab(\''+t[0]+'\')"><span class="tab-icon" style="'+(a?'':'filter:grayscale(1) opacity(.5)')+'">'+t[2]+'</span><span class="tab-label" style="color:'+c+'">'+t[1]+'</span>';
    if(a)h+='<div class="tab-dot"></div>';h+='</button>'}
  return h+'</div>';
}
function switchTab(id){S.tab=id;render()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var initAttempts=0;
function initApp(){
  initAttempts++;var lt=document.getElementById('loading-text');
  if(!API_URL){
    document.getElementById('loading').innerHTML='<div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#4F8CFF,#3B6FDB);display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ’°</div><div style="color:var(--red);font-size:13px;font-weight:600;margin-top:12px">API URL not configured</div><div style="color:var(--text2);font-size:11px;margin-top:8px;padding:0 24px;text-align:center">Open index.html and set your Apps Script URL in the <strong style="color:var(--text)">API_URL</strong> variable at the top of the script section.</div>';
    return;
  }
  if(lt)lt.textContent='Loading data... ('+initAttempts+')';
  apiGet().then(function(data){
    S.people=data.people||[];S.transactions=data.transactions||[];
    document.getElementById('loading').style.display='none';document.getElementById('app').style.display='block';render();
  }).catch(function(err){
    if(initAttempts<3){setTimeout(initApp,1000);return}
    document.getElementById('loading').innerHTML='<div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#EF4565,#c0354a);display:flex;align-items:center;justify-content:center;font-size:22px">âš ï¸</div><div style="color:var(--red);font-size:13px;font-weight:600;margin-top:12px">Connection Error</div><div style="color:var(--text2);font-size:11px;margin-top:8px;padding:0 24px;text-align:center">'+(err.message||String(err))+'</div><button onclick="initAttempts=0;initApp()" style="margin-top:16px;padding:10px 22px;border-radius:11px;background:var(--accent);color:#fff;border:none;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font)">Retry</button>';
  });
}
setTimeout(initApp,100);
</script>
</body>
</html>
